<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘¾</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Killer v6.1 Fixed</title>
    <style>
        :root {
            --bg-deep: #05050a;
            --glass-panel: rgba(20, 20, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-c1: #00f2ff; --neon-c1-dim: rgba(0, 242, 255, 0.1);
            --neon-c2: #ff00ff; --neon-c2-dim: rgba(255, 0, 255, 0.1);
            --text-main: #e2e8f0; --text-muted: #94a3b8; --danger: #ff2a6d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; user-select: none; }
        
        body { 
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%);
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* Prevent body scroll, handle in panels */
        }

        /* --- SCROLLBARS (Made visible and styled) --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a10; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* --- TOP BAR --- */
        .top-bar { 
            flex: 0 0 50px; /* Fixed height */
            padding: 0 20px;
            background: #0a0a12;
            border-bottom: 1px solid var(--glass-border);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 100;
        }
        .logo-text {
            font-weight: 800; font-size: 1.1rem; letter-spacing: 1px;
            color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* --- GRID LAYOUT --- */
        .main-grid { 
            flex: 1; /* Take remaining height */
            display: grid; 
            height: 100%; /* Fill remaining space */
            overflow: hidden; 
            transition: 0.3s ease;
        }
        .layout-single { grid-template-columns: 320px 1fr 260px; }
        .layout-dual { grid-template-columns: 320px 1fr 1fr 220px; }

        .panel { 
            display: flex; flex-direction: column; 
            border-right: 1px solid var(--glass-border);
            background: var(--glass-panel);
            height: 100%; /* Ensure it fills parent */
            min-height: 0; /* Flexbox scrolling fix */
        }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        .results-panel { background: rgba(0,0,0,0.3); }

        /* --- INPUTS --- */
        .section { padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); margin-bottom: 15px; }
        .h-title { font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: space-between; }
        
        .input-group { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; border: 1px solid var(--glass-border); }
        .border-c1 { border-left: 3px solid var(--neon-c1); }
        .border-c2 { border-left: 3px solid var(--neon-c2); }
        .row { display: flex; gap: 8px; align-items: center; }
        .flex-1 { flex: 1; }
        label { font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 3px; }
        input, select { background: #111; border: 1px solid #333; color: #fff; padding: 6px; border-radius: 4px; width: 100%; outline: none; font-size: 0.9rem; }
        input:focus { border-color: var(--neon-c1); }

        /* --- BUTTONS --- */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-primary { background: linear-gradient(135deg, var(--neon-c1), #00b8d4); color: #000; box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(0,242,255,0.4); }
        .btn-sec { background: #222; color: #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #333; }
        
        /* --- TOGGLE --- */
        .switch { width: 36px; height: 20px; background: #222; border-radius: 10px; position: relative; transition: 0.3s; border: 1px solid #444; margin-right: 10px; }
        .switch::after { content:''; position: absolute; top:2px; left:2px; width:14px; height:14px; background:#fff; border-radius:50%; transition:0.3s; }
        input:checked + .switch { background: var(--neon-c2); border-color: var(--neon-c2); }
        input:checked + .switch::after { transform: translateX(16px); }

        /* --- KEYPADS --- */
        .side-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 20px; }
        .key-btn { aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 6px; font-size: 1.2rem; color: #888; display: grid; place-items: center; cursor: pointer; }
        
        /* Mini Strip (Inside results) */
        .mini-strip { padding: 10px; border-bottom: 1px solid var(--glass-border); background: rgba(10,10,15,0.95); flex: 0 0 auto; }
        .mini-pad { display: flex; gap: 3px; margin-top: 5px; }
        .mini-key { flex: 1; height: 30px; background: #151515; border: 1px solid #333; border-radius: 3px; color: #777; display: grid; place-items: center; cursor: pointer; font-size: 0.9rem; }
        
        /* States */
        .in { color: #000 !important; font-weight: bold; box-shadow: 0 0 8px currentColor; }
        .ex { background: rgba(255, 42, 109, 0.15) !important; color: var(--danger) !important; border-color: var(--danger) !important; }
        .c1-theme .in { background: var(--neon-c1); border-color: var(--neon-c1); color: #000; }
        .c2-theme .in { background: var(--neon-c2); border-color: var(--neon-c2); color: #000; }
        .ghost { opacity: 0.1; pointer-events: none; }

        /* --- SMART GRAPHS (Top 3) --- */
        .stats-box { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; height: 16px; }
        .stat-lbl { width: 15px; text-align: center; font-weight: bold; color: var(--text-muted); }
        .stat-track { flex: 1; height: 4px; background: #222; border-radius: 2px; overflow: hidden; }
        .stat-bar { height: 100%; border-radius: 2px; width: 0; transition: width 0.5s ease; }
        .stat-val { width: 25px; text-align: right; font-family: monospace; color: #888; }
        
        /* --- RESULTS --- */
        .res-group { margin-bottom: 10px; border: 1px solid #333; border-radius: 4px; overflow: hidden; }
        .res-head { background: #151515; padding: 5px 10px; font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid #222; color: #ddd; }
        .res-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1px; background: #333; }
        .card { background: #0a0a0a; padding: 8px 0; text-align: center; font-family: monospace; font-size: 1.1rem; cursor: pointer; color: #ccc; }
        .card:hover { background: #222; color: #fff; z-index: 1; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .remover-item { display: flex; justify-content: space-between; padding: 6px; background: #111; border: 1px solid #333; margin-bottom: 4px; font-size: 0.8rem; border-radius: 4px; }
        .del-x { color: var(--danger); cursor: pointer; font-weight: bold; padding: 0 5px; }
        
        /* Sets */
        .set-row { display: flex; gap: 2px; margin-top: 5px; }
        .set-d { flex: 1; aspect-ratio: 1; background: #111; border: 1px solid #333; display: grid; place-items: center; cursor: pointer; border-radius: 3px; font-size: 0.8rem; }
        .set-d.active { background: var(--neon-c1); color: #000; font-weight: bold; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="logo-text">ðŸ‘¾ NEON KILLER v6.1</div>
    <div style="display:flex; gap:10px">
        <button class="btn-sec" onclick="undo()">â†¶ Undo</button>
        <button class="btn-sec" onclick="redo()">â†· Redo</button>
    </div>
</div>

<div id="layoutGrid" class="main-grid layout-single">
    
    <div class="panel">
        <div class="scroll-area">
            <div class="section">
                <div class="h-title" style="color:var(--neon-c1)">Cage 1</div>
                <div class="input-group border-c1">
                    <div class="row">
                        <div class="flex-1"><label>Sum</label><div class="row"><input type="number" id="s1min" value="10"><input type="number" id="s1max" value="10"></div></div>
                        <div class="flex-1"><label>Size</label><div class="row"><input type="number" id="z1min" value="2"><input type="number" id="z1max" value="2"></div></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <label style="display:flex; align-items:center; cursor:pointer; margin-bottom:10px">
                    <input type="checkbox" id="dualCheck" style="display:none" onchange="toggleDual()">
                    <div class="switch"></div>
                    <span class="h-title" style="margin:0; color:var(--neon-c2)">Enable Cage 2</span>
                </label>
                <div id="dualInputs" class="hidden">
                    <div class="input-group border-c2">
                        <div class="row">
                            <div class="flex-1"><label>Sum</label><div class="row"><input type="number" id="s2min" value="12"><input type="number" id="s2max" value="12"></div></div>
                            <div class="flex-1"><label>Size</label><div class="row"><input type="number" id="z2min" value="2"><input type="number" id="z2max" value="2"></div></div>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top:10px">
                        <div class="h-title">Supervisor</div>
                        <div class="row">
                            <div class="flex-1"><label>Max Overlap</label><input type="number" id="maxOverlap" value="0"></div>
                            <div class="flex-1" style="padding-top:14px"><label><input type="checkbox" id="conflictMode" checked> Same House</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="h-title">Logic Filters</div>
                <div class="input-group">
                    <select id="parityTarget" class="hidden" style="margin-bottom:5px"><option value="both">Apply to Both</option><option value="1">Cage 1</option><option value="2">Cage 2</option></select>
                    <div class="row">
                        <select id="pType" class="flex-1"><option value="none">None</option><option value="odd">Odd</option><option value="even">Even</option></select>
                        <select id="pCond" class="flex-1"><option value="min">At Least</option><option value="exact">Exactly</option></select>
                        <input type="number" id="pCount" value="1" style="width:40px">
                    </div>
                </div>
                <div id="setsList" style="margin-top:10px"></div>
                <button class="btn-sec" style="width:100%; margin-top:10px" onclick="addSet()">+ Add Set</button>
            </div>
            <button class="btn btn-primary" onclick="run()">Generate</button>
        </div>
    </div>

    <div class="panel results-panel c1-theme">
        <div id="strip1" class="mini-strip hidden">
            <div class="h-title" style="color:var(--neon-c1)">Cage 1: <span id="cnt1" style="color:#fff">0</span></div>
            <div class="mini-pad" id="miniPad1"></div>
            <div id="stats1" class="stats-box"></div>
        </div>
        <div id="out1" class="scroll-area"></div>
    </div>

    <div id="panelRes2" class="panel results-panel c2-theme hidden">
        <div class="mini-strip">
            <div class="h-title" style="color:var(--neon-c2)">Cage 2: <span id="cnt2" style="color:#fff">0</span></div>
            <div class="mini-pad" id="miniPad2"></div>
            <div id="stats2" class="stats-box"></div>
        </div>
        <div id="out2" class="scroll-area"></div>
    </div>

    <div class="panel">
        <div class="scroll-area">
            <div id="sidebarKeypadBox">
                <div class="h-title" style="color:var(--neon-c1)">Global Keypad</div>
                <div class="side-keypad c1-theme" id="globalPad"></div>
                <div class="h-title">Top Suggestions</div>
                <div id="globalStats" class="stats-box" style="margin-bottom:20px"></div>
            </div>

            <div class="h-title">Active Filters</div>
            <div id="removerList"></div>
        </div>
    </div>
</div>

<script>
    let state = { c1: {i:new Set(), e:new Set()}, c2: {i:new Set(), e:new Set()}, sets: [], excl: new Set(), hSum: new Set(), hSize: new Set() };
    let hist = [], redoStack = [];
    let dual = false;

    window.onload = () => { genKeypads(); run(); };

    // LOGIC
    function getCombos(sMin, sMax, zMin, zMax) {
        let res = [];
        for(let z=zMin; z<=zMax; z++) { for(let s=sMin; s<=sMax; s++) { backtrack(1, s, z, [], res); } }
        return res;
    }
    function backtrack(start, target, size, path, res) {
        if(path.length===size) { if(target===0) res.push({d:[...path], sum:path.reduce((a,b)=>a+b,0), size:size}); return; }
        for(let i=start; i<=9; i++) { if(i<=target) { path.push(i); backtrack(i+1, target-i, size, path, res); path.pop(); } }
    }

    function check(c, cid) {
        const d=c.d, f=cid===1?state.c1:state.c2;
        if(state.hSum.has(`${cid}-${c.sum}`) || state.hSize.has(`${cid}-${c.size}`)) return false;
        for(let x of f.i) if(!d.includes(x)) return false;
        for(let x of f.e) if(d.includes(x)) return false;
        
        const pTarg = document.getElementById('parityTarget').value;
        if(!dual || pTarg==='both' || pTarg==cid) {
            const type=document.getElementById('pType').value, cond=document.getElementById('pCond').value, req=+document.getElementById('pCount').value;
            if(type!=='none') {
                const has = d.filter(n=>type==='odd'?n%2!==0:n%2===0).length;
                if((cond==='min' && has<req) || (cond==='exact' && has!==req)) return false;
            }
        }
        for(let s of state.sets) {
            if(!dual || s.target==='both' || s.target==cid) {
                if(s.digits.size>0) {
                    const ov = d.filter(n=>s.digits.has(n)).length;
                    if((s.mode==='only' && d.some(n=>!s.digits.has(n))) || (s.mode==='count' && ov!==s.count)) return false;
                }
            }
        }
        if(state.excl.has(JSON.stringify(d))) return false;
        return true;
    }

    function run() {
        const s1min=+document.getElementById('s1min').value, s1max=+document.getElementById('s1max').value;
        const z1min=+document.getElementById('z1min').value, z1max=+document.getElementById('z1max').value;
        let l1 = getCombos(s1min, s1max, z1min, z1max).filter(c=>check(c, 1));

        let l2 = [];
        if(dual) {
            const s2min=+document.getElementById('s2min').value, s2max=+document.getElementById('s2max').value;
            const z2min=+document.getElementById('z2min').value, z2max=+document.getElementById('z2max').value;
            l2 = getCombos(s2min, s2max, z2min, z2max).filter(c=>check(c, 2));
            
            const maxO=+document.getElementById('maxOverlap').value, strict=document.getElementById('conflictMode').checked;
            const v1 = l1.filter(c1=>l2.some(c2=>isCompat(c1.d, c2.d, maxO, strict)));
            const v2 = l2.filter(c2=>l1.some(c1=>isCompat(c1.d, c2.d, maxO, strict)));
            l1=v1; l2=v2;
        }

        renderRes(l1, 'out1', 'cnt1', 1);
        renderTop3(l1, 'stats1', state.c1, 'var(--neon-c1)');
        
        // Global Stats uses l1 in Single Mode
        if(!dual) renderTop3(l1, 'globalStats', state.c1, 'var(--neon-c1)');

        if(dual) {
            renderRes(l2, 'out2', 'cnt2', 2);
            renderTop3(l2, 'stats2', state.c2, 'var(--neon-c2)');
        }
        
        updatePads(getGhosts(l1), getGhosts(l2));
        renderRemovers(l1, l2);
    }

    function isCompat(d1, d2, max, strict) { const shared = d1.filter(x=>d2.includes(x)).length; return strict ? shared <= max : true; }
    function getGhosts(list) { let f=new Set(); list.forEach(c=>c.d.forEach(n=>f.add(n))); let g=new Set(); for(let i=1;i<=9;i++)if(!f.has(i))g.add(i); return g; }

    // RENDERERS
    function renderRes(list, boxId, cntId, cid) {
        document.getElementById(cntId).innerText = list.length;
        const box = document.getElementById(boxId); box.innerHTML='';
        let g={}; list.forEach(c=>{ const k=`${c.size}-${c.sum}`; if(!g[k])g[k]=[]; g[k].push(c) });
        
        Object.keys(g).sort().forEach(k=>{
            const [z,s] = k.split('-');
            const d=document.createElement('div'); d.className='res-group';
            d.innerHTML = `<div class="res-head" style="color:${cid===1?'var(--neon-c1)':'var(--neon-c2)'}">Sum ${s} (${z})</div>`;
            const gr=document.createElement('div'); gr.className='res-grid';
            g[k].forEach(c=>{
                const cd=document.createElement('div'); cd.className='card'; cd.innerText = c.d.join(' ');
                cd.onclick = ()=>{ save(); state.excl.add(JSON.stringify(c.d)); run(); };
                gr.appendChild(cd);
            });
            d.appendChild(gr); box.appendChild(d);
        });
    }

    function renderTop3(list, id, filters, color) {
        const el = document.getElementById(id); el.innerHTML='';
        if(!list.length) return;
        
        // Calc Frequency
        let counts = {};
        list.forEach(c => c.d.forEach(n => counts[n] = (counts[n]||0)+1));
        
        // Filter & Sort: Top 3 that are NOT selected or excluded
        let sorted = Object.keys(counts)
            .map(n => parseInt(n))
            .filter(n => !filters.i.has(n) && !filters.e.has(n)) // Exclude selected
            .sort((a,b) => counts[b] - counts[a]);
        
        // Show max 3
        sorted.slice(0, 3).forEach(n => {
            const pct = Math.round((counts[n] / list.length) * 100);
            const row = document.createElement('div'); row.className = 'stat-row';
            row.innerHTML = `
                <div class="stat-lbl">${n}</div>
                <div class="stat-track"><div class="stat-bar" style="width:${pct}%; background:${color}"></div></div>
                <div class="stat-val">${pct}%</div>
            `;
            el.appendChild(row);
        });
    }

    function renderRemovers(l1, l2) {
        const list = document.getElementById('removerList'); list.innerHTML='';
        const add = (l, cid) => {
            let sums=new Set(), sizes=new Set(); l.forEach(c=>{sums.add(c.sum); sizes.add(c.size)});
            [...sums].sort((a,b)=>a-b).forEach(s=>{
                if(state.hSum.has(`${cid}-${s}`)) return;
                const r=document.createElement('div'); r.className='remover-item';
                r.style.borderLeft=`3px solid ${cid===1?'var(--neon-c1)':'var(--neon-c2)'}`;
                r.innerHTML=`<span>Cage ${cid}: Sum ${s}</span><span class="del-x" onclick="hide(1,${cid},${s})">âœ•</span>`;
                list.appendChild(r);
            });
            [...sizes].sort((a,b)=>a-b).forEach(z=>{
                if(state.hSize.has(`${cid}-${z}`)) return;
                const r=document.createElement('div'); r.className='remover-item';
                r.style.borderLeft=`3px solid ${cid===1?'var(--neon-c1)':'var(--neon-c2)'}`;
                r.innerHTML=`<span>Cage ${cid}: Size ${z}</span><span class="del-x" onclick="hide(2,${cid},${z})">âœ•</span>`;
                list.appendChild(r);
            });
        };
        add(l1,1); if(dual) add(l2,2);
    }
    function hide(type, cid, val) { save(); (type===1?state.hSum:state.hSize).add(`${cid}-${val}`); run(); }

    // UI UTILS
    function genKeypads() {
        const gp = document.getElementById('globalPad'); gp.innerHTML='';
        for(let i=1; i<=9; i++) gp.appendChild(makeKey(i, 1, true));
        const mp1 = document.getElementById('miniPad1'); mp1.innerHTML='';
        const mp2 = document.getElementById('miniPad2'); mp2.innerHTML='';
        for(let i=1; i<=9; i++) { mp1.appendChild(makeKey(i, 1, false)); mp2.appendChild(makeKey(i, 2, false)); }
    }
    function makeKey(n, cid, big) {
        const k = document.createElement('div'); k.className = big ? 'key-btn' : 'mini-key';
        k.innerText = n; k.id = big ? `gk-${n}` : `mk${cid}-${n}`;
        k.onmousedown = (e) => { e.preventDefault(); save(); 
            const f = cid===1 ? state.c1 : state.c2;
            if(e.shiftKey || e.button===2) f.e.has(n)?f.e.delete(n):(f.e.add(n),f.i.delete(n));
            else f.i.has(n)?f.i.delete(n):(f.i.add(n),f.e.delete(n));
            run();
        };
        k.oncontextmenu=e=>e.preventDefault(); return k;
    }
    function updatePads(g1, g2) {
        const up = (idPrefix, f, ghosts) => {
            for(let i=1; i<=9; i++) {
                const k = document.getElementById(`${idPrefix}${i}`); if(!k) continue;
                k.className = idPrefix.includes('gk') ? 'key-btn' : 'mini-key';
                if(f.i.has(i)) k.classList.add('in'); if(f.e.has(i)) k.classList.add('ex');
                if(ghosts.has(i)) k.classList.add('ghost');
            }
        };
        up('gk-', state.c1, g1); up('mk1-', state.c1, g1); up('mk2-', state.c2, g2);
    }

    function addSet() { save(); state.sets.push({id:Date.now(), digits:new Set(), target:'both', mode:'only', count:1}); drawSets(); }
    function drawSets() {
        const d = document.getElementById('setsList'); d.innerHTML='';
        state.sets.forEach(s => {
            const targetUI = dual ? `<select onchange="updSet(${s.id},'target',this.value)" style="width:auto; margin:0; font-size:0.75rem"><option value="both" ${s.target=='both'?'selected':''}>Both</option><option value="1" ${s.target=='1'?'selected':''}>Cage 1</option><option value="2" ${s.target=='2'?'selected':''}>Cage 2</option></select>` : '';
            const countUI = s.mode==='count' ? `<input type="number" value="${s.count}" onchange="updSet(${s.id},'count',+this.value)" style="width:40px">` : '';
            const el = document.createElement('div'); el.className='input-group';
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; gap:5px; margin-bottom:5px">
                    ${targetUI}
                    <select onchange="updSet(${s.id},'mode',this.value)" style="width:auto; font-size:0.75rem"><option value="only" ${s.mode=='only'?'selected':''}>Allow Only</option><option value="count" ${s.mode=='count'?'selected':''}>Req Count</option></select>
                    ${countUI}
                    <button class="btn-sec" style="width:auto; padding:2px 8px; color:var(--danger)" onclick="delSet(${s.id})">âœ•</button>
                </div>
                <div class="set-row">${[1,2,3,4,5,6,7,8,9].map(n=>`<div class="set-d ${s.digits.has(n)?'active':''}" onclick="togSet(${s.id},${n})">${n}</div>`).join('')}</div>
            `;
            d.appendChild(el);
        });
    }
    function togSet(id,n){ let s=state.sets.find(x=>x.id===id); s.digits.has(n)?s.digits.delete(n):s.digits.add(n); drawSets(); run(); }
    function updSet(id,k,v){ save(); state.sets.find(x=>x.id===id)[k]=v; if(k==='mode')drawSets(); run(); }
    function delSet(id){ save(); state.sets=state.sets.filter(x=>x.id!==id); drawSets(); run(); }

    function toggleDual() {
        dual = document.getElementById('dualCheck').checked;
        document.getElementById('layoutGrid').className = dual ? 'main-grid layout-dual' : 'main-grid layout-single';
        document.getElementById('dualInputs').classList.toggle('hidden', !dual);
        document.getElementById('panelRes2').classList.toggle('hidden', !dual);
        document.getElementById('parityTarget').classList.toggle('hidden', !dual);
        document.getElementById('sidebarKeypadBox').classList.toggle('hidden', dual);
        document.getElementById('strip1').classList.toggle('hidden', !dual);
        drawSets(); run();
    }

    function save() { hist.push(JSON.stringify({c1:{i:[...state.c1.i],e:[...state.c1.e]}, c2:{i:[...state.c2.i],e:[...state.c2.e]}, excl:[...state.excl], hSum:[...state.hSum], hSize:[...state.hSize], sets:state.sets.map(s=>({...s,digits:[...s.digits]}))})); if(hist.length>20)hist.shift(); redoStack=[]; }
    function undo() { if(hist.length){ redoStack.push(snap()); load(hist.pop()); } }
    function redo() { if(redoStack.length){ hist.push(snap()); load(redoStack.pop()); } }
    function snap() { return JSON.stringify({c1:{i:[...state.c1.i],e:[...state.c1.e]}, c2:{i:[...state.c2.i],e:[...state.c2.e]}, excl:[...state.excl], hSum:[...state.hSum], hSize:[...state.hSize], sets:state.sets.map(s=>({...s,digits:[...s.digits]}))}); }
    function load(s) { const o=JSON.parse(s); state.c1={i:new Set(o.c1.i),e:new Set(o.c1.e)}; state.c2={i:new Set(o.c2.i),e:new Set(o.c2.e)}; state.excl=new Set(o.excl); state.hSum=new Set(o.hSum); state.hSize=new Set(o.hSize); state.sets=o.sets.map(s=>({...s,digits:new Set(s.digits)})); drawSets(); run(); }
</script>
</body>
</html>
