<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/svg+xml" href="DARKfavicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß© Killer Sudoku Cage Combination Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #050508 0%, #0a0a0f 50%, #0f0f1a 100%);
            color: #f8fafc;
            min-height: 100vh;
            line-height: 1.4;
        }

        .header {
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid rgba(100, 255, 218, 0.15);
            background: rgba(5, 5, 8, 0.8);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            color: #64ffda;
            text-shadow: 0 0 15px rgba(100, 255, 218, 0.3);
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            padding: 15px;
            min-height: calc(100vh - 100px);
        }

        .results-column {
            background: rgba(15, 15, 26, 0.4);
            border: 1px solid rgba(100, 255, 218, 0.1);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
        }

        .controls-column {
            background: rgba(15, 15, 26, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(100, 255, 218, 0.1);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 18px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            font-weight: 600;
            color: #64ffda;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .single-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(100, 255, 218, 0.05);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
        }

        .range-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
        }

        .single-input-group.hidden,
        .range-input-group.hidden {
            display: none;
        }

        input[type="number"] {
            background: rgba(248, 250, 252, 0.05);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 6px;
            padding: 6px 10px;
            color: #f8fafc;
            font-size: 13px;
            width: 70px;
            transition: all 0.2s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 8px rgba(100, 255, 218, 0.3);
            background: rgba(248, 250, 252, 0.08);
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #64ffda;
        }

        .button {
            background: linear-gradient(135deg, #64ffda, #00bfa5);
            color: #0a0a0f;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(100, 255, 218, 0.4);
        }

        .button-secondary {
            background: rgba(139, 92, 246, 0.8);
            color: #f8fafc;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .button-secondary:hover {
            background: rgba(139, 92, 246, 1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .button-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .button-small {
            padding: 6px 12px;
            font-size: 11px;
        }

        .generate-button {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            font-size: 1rem;
            background: linear-gradient(135deg, #64ffda, #00bfa5);
            color: #0a0a0f;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 255, 218, 0.5);
        }

        .groups-container {
            border: 1px solid rgba(100, 255, 218, 0.15);
            border-radius: 8px;
            padding: 12px;
            background: rgba(100, 255, 218, 0.03);
        }

        .group {
            background: rgba(248, 250, 252, 0.03);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(248, 250, 252, 0.08);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .group-header h4 {
            color: #8b5cf6;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .digits-container {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .digit-button {
            width: 28px;
            height: 28px;
            border: 1px solid rgba(100, 255, 218, 0.25);
            background: rgba(100, 255, 218, 0.08);
            color: #64ffda;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 12px;
            position: relative;
        }

        .digit-button.selected {
            background: #64ffda;
            color: #0a0a0f;
        }

        .digit-button:hover {
            background: rgba(100, 255, 218, 0.15);
        }

        .digit-button.auto-updated {
            animation: enhanced-highlight 2.5s ease-out;
        }

        @keyframes enhanced-highlight {
            0% { 
                transform: scale(1.15);
                box-shadow: 0 0 20px rgba(100, 255, 218, 0.8);
                background: rgba(100, 255, 218, 0.4);
                border-color: #64ffda;
            }
            25% {
                transform: scale(1.1);
                box-shadow: 0 0 15px rgba(100, 255, 218, 0.6);
                background: rgba(100, 255, 218, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 10px rgba(100, 255, 218, 0.4);
                background: rgba(100, 255, 218, 0.2);
            }
            100% { 
                transform: scale(1);
                box-shadow: none;
                background: rgba(100, 255, 218, 0.08);
            }
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .advanced-filtering {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.15);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .digit-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 6px;
            margin-top: 12px;
        }

        .overview-bar {
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(100, 255, 218, 0.15);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.4);
        }

        .overview-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .overview-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .overview-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .count-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .count-badge {
            background: #64ffda;
            color: #0a0a0f;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
        }

        .count-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(100, 255, 218, 0.4);
        }

        .total-badge {
            background: #8b5cf6;
            color: #f8fafc;
            font-size: 13px;
            padding: 4px 12px;
        }

        /* Statistics Dashboard */
        .statistics-dashboard {
            background: rgba(15, 15, 26, 0.7);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .stats-header {
            color: #8b5cf6;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 11px;
        }

        .digit-frequency {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 3px;
            margin-bottom: 8px;
        }

        .freq-bar {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 3px;
            text-align: center;
            padding: 4px 2px;
            color: #8b5cf6;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .freq-bar.most-common {
            background: rgba(100, 255, 218, 0.2);
            border-color: rgba(100, 255, 218, 0.4);
            color: #64ffda;
            animation: pulse-glow 2s infinite;
        }

        .freq-bar.least-common {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(100, 255, 218, 0.3); }
            50% { box-shadow: 0 0 15px rgba(100, 255, 218, 0.6); }
        }

        .freq-number {
            display: block;
            font-size: 9px;
            margin-bottom: 2px;
        }

        .freq-count {
            display: block;
            font-size: 8px;
            opacity: 0.8;
        }

        .sum-frequency {
            max-height: 60px;
            overflow-y: auto;
        }

        .sum-freq-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 4px;
            margin: 1px 0;
            background: rgba(100, 255, 218, 0.08);
            border-radius: 3px;
            font-size: 10px;
        }

        .sum-freq-item.top-sum {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            font-weight: 600;
        }

        .cage-size-section {
            margin-bottom: 20px;
        }

        .cage-size-header {
            color: #64ffda;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid rgba(100, 255, 218, 0.25);
        }

        .sum-section {
            margin-bottom: 15px;
        }

        .sum-header {
            color: #8b5cf6;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .sum-remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sum-header:hover .sum-remove-btn {
            opacity: 1;
        }

        .sum-remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .combinations {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
        }

        .combination {
            background: rgba(248, 250, 252, 0.04);
            border: 1px solid rgba(248, 250, 252, 0.08);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .combination:hover {
            background: rgba(248, 250, 252, 0.08);
            border-color: rgba(100, 255, 218, 0.25);
        }

        .combination.grayed-out {
            opacity: 0.35;
            background: rgba(148, 163, 184, 0.06);
            border-color: rgba(148, 163, 184, 0.15);
        }

        .combination-digits {
            font-weight: 600;
            color: #64ffda;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            font-size: 14px;
        }

        .combination.grayed-out .combination-digits {
            color: #64748b;
        }

        .clickable-digit {
            background: rgba(100, 255, 218, 0.08);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 3px;
            padding: 1px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-digit:hover {
            background: rgba(100, 255, 218, 0.15);
            transform: scale(1.1);
        }

        .restore-hint {
            position: absolute;
            top: 3px;
            right: 5px;
            color: #64748b;
            font-size: 10px;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        .sum-exclusions {
            margin-top: 12px;
        }

        .sum-exclusion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 4px;
            margin-top: 8px;
        }

        .sum-button {
            padding: 6px;
            border: 1px solid rgba(239, 68, 68, 0.25);
            background: rgba(239, 68, 68, 0.08);
            color: #ef4444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
        }

        .sum-button.excluded {
            background: #ef4444;
            color: white;
        }

        .sum-button:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #64748b;
        }

        .empty-state h3 {
            color: #64ffda;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .empty-state p {
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .results-column {
                order: 2;
            }
            
            .controls-column {
                order: 1;
            }

            .stats-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß© Killer Sudoku Cage Combination Tool</h1>
        <p>Generate and manage valid cage combinations with advanced filtering</p>
    </div>

    <div class="main-container">
        <!-- Results Column (Left) -->
        <div class="results-column">
            <div class="empty-state" id="emptyState">
                <h3>üéØ Ready to Generate</h3>
                <p>Configure your parameters on the right and click "Generate Combinations" to see results here.</p>
            </div>

            <!-- Statistics Dashboard -->
            <div class="statistics-dashboard hidden" id="statisticsDashboard">
                <div class="stats-header">
                    üìä Statistics
                </div>
                <div class="stats-content">
                    <div>
                        <div style="margin-bottom: 6px; font-weight: 600; color: #8b5cf6;">Digit Frequency:</div>
                        <div class="digit-frequency" id="digitFrequency"></div>
                    </div>
                    <div>
                        <div style="margin-bottom: 6px; font-weight: 600; color: #8b5cf6;">Top Sums:</div>
                        <div class="sum-frequency" id="sumFrequency"></div>
                    </div>
                </div>
            </div>

            <!-- Overview Bar -->
            <div class="overview-bar hidden" id="overviewBar">
                <div class="overview-content">
                    <div class="overview-row">
                        <div class="overview-item">
                            <span>Total Combinations:</span>
                            <span class="count-badge total-badge" id="totalCount">0</span>
                        </div>
                    </div>
                    <div class="overview-row">
                        <div class="overview-item">
                            <span>By Size:</span>
                            <div class="count-badges" id="sizeCountsContainer"></div>
                        </div>
                    </div>
                    <div class="overview-row">
                        <div class="overview-item">
                            <span>By Sum:</span>
                            <div class="count-badges" id="sumCountsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="results hidden" id="resultsSection">
                <div id="resultsContainer"></div>
            </div>
        </div>

        <!-- Controls Column (Right) -->
        <div class="controls-column">
            <!-- Cage Size Control -->
            <div class="control-group">
                <label class="control-label">üî¢ Cage Size</label>
                <div class="input-container">
                    <div class="single-input-group" id="cageSizeSingle">
                        <input type="number" id="cageSizeValue" min="1" max="9" value="3">
                        <button class="button button-secondary button-small" onclick="splitCageSize()">Split to Range</button>
                    </div>
                    <div class="range-input-group hidden" id="cageSizeRange">
                        <input type="number" id="cageSizeMin" min="1" max="9" value="2" placeholder="Min">
                        <span>‚Äî</span>
                        <input type="number" id="cageSizeMax" min="1" max="9" value="4" placeholder="Max">
                        <button class="button button-secondary button-small" onclick="mergeCageSize()">Single Value</button>
                    </div>
                </div>
            </div>

            <!-- Sum Control -->
            <div class="control-group">
                <label class="control-label">‚ûï Target Sum</label>
                <div class="input-container">
                    <div class="single-input-group" id="sumSingle">
                        <input type="number" id="sumValue" min="3" max="45" value="15">
                        <button class="button button-secondary button-small" onclick="splitSum()">Split to Range</button>
                    </div>
                    <div class="range-input-group hidden" id="sumRange">
                        <input type="number" id="sumMin" min="3" max="45" value="6" placeholder="Min">
                        <span>‚Äî</span>
                        <input type="number" id="sumMax" min="3" max="45" value="24" placeholder="Max">
                        <button class="button button-secondary button-small" onclick="mergeSum()">Single Value</button>
                    </div>
                </div>
            </div>

            <!-- Duplicate Digits Option -->
            <div class="control-group">
                <div class="checkbox-container">
                    <input type="checkbox" id="allowDuplicates">
                    <label for="allowDuplicates">üîÑ Allow duplicate digits (e.g., [1,1,3])</label>
                </div>
                <div class="input-container" style="margin-top: 8px;">
                    <label>Max repetitions per digit:</label>
                    <input type="number" id="maxRepetitions" min="1" max="9" value="2" disabled>
                </div>
            </div>

            <!-- Groups of Digits -->
            <div class="control-group">
                <label class="control-label">üéØ Digit Groups</label>
                <div class="groups-container">
                    <div id="groupsContainer"></div>
                    <button class="button" onclick="addGroup()">+ Add Group</button>
                </div>
            </div>

            <button class="generate-button" onclick="generateCombinations()">üöÄ Generate Combinations</button>

            <!-- Advanced Filtering Section -->
            <div class="advanced-filtering hidden" id="advancedFilteringSection">
                <label class="control-label">‚öôÔ∏è Advanced Filtering</label>
                
                <div class="control-group">
                    <label>Include Digits (must appear in all combinations):</label>
                    <div class="digit-grid" id="includeDigits"></div>
                </div>

                <div class="control-group">
                    <label>Exclude Digits (never appear):</label>
                    <div class="digit-grid" id="excludeDigits"></div>
                </div>

                <div class="sum-exclusions">
                    <label>Exclude Specific Sums:</label>
                    <div class="sum-exclusion-grid" id="sumExclusions"></div>
                </div>

                <button class="button" onclick="displayResults()" style="margin-top: 12px; width: 100%;">üîÑ Update Results</button>
            </div>
        </div>
    </div>

    <script>
        let groups = [];
        let includeDigits = new Set();
        let excludeDigits = new Set();
        let excludeSums = new Set();
        let excludedCombinations = new Set();
        let allCombinations = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeDigitGrids();
            initializeSumExclusions();
        });

        function setupEventListeners() {
            // Allow duplicates checkbox
            document.getElementById('allowDuplicates').addEventListener('change', function() {
                const maxRep = document.getElementById('maxRepetitions');
                maxRep.disabled = !this.checked;
            });
        }

        function splitCageSize() {
            const singleGroup = document.getElementById('cageSizeSingle');
            const rangeGroup = document.getElementById('cageSizeRange');
            const value = parseInt(document.getElementById('cageSizeValue').value);
            
            // Set range defaults based on current value
            document.getElementById('cageSizeMin').value = Math.max(1, value - 1);
            document.getElementById('cageSizeMax').value = Math.min(9, value + 1);
            
            singleGroup.classList.add('hidden');
            rangeGroup.classList.remove('hidden');
        }

        function mergeCageSize() {
            const singleGroup = document.getElementById('cageSizeSingle');
            const rangeGroup = document.getElementById('cageSizeRange');
            const min = parseInt(document.getElementById('cageSizeMin').value);
            const max = parseInt(document.getElementById('cageSizeMax').value);
            
            // Set single value to middle of range
            document.getElementById('cageSizeValue').value = Math.floor((min + max) / 2);
            
            rangeGroup.classList.add('hidden');
            singleGroup.classList.remove('hidden');
        }

        function splitSum() {
            const singleGroup = document.getElementById('sumSingle');
            const rangeGroup = document.getElementById('sumRange');
            const value = parseInt(document.getElementById('sumValue').value);
            
            // Set range defaults based on current value
            document.getElementById('sumMin').value = Math.max(3, value - 5);
            document.getElementById('sumMax').value = Math.min(45, value + 5);
            
            singleGroup.classList.add('hidden');
            rangeGroup.classList.remove('hidden');
        }

        function mergeSum() {
            const singleGroup = document.getElementById('sumSingle');
            const rangeGroup = document.getElementById('sumRange');
            const min = parseInt(document.getElementById('sumMin').value);
            const max = parseInt(document.getElementById('sumMax').value);
            
            // Set single value to middle of range
            document.getElementById('sumValue').value = Math.floor((min + max) / 2);
            
            rangeGroup.classList.add('hidden');
            singleGroup.classList.remove('hidden');
        }

        function initializeDigitGrids() {
            const includeContainer = document.getElementById('includeDigits');
            const excludeContainer = document.getElementById('excludeDigits');

            for (let i = 1; i <= 9; i++) {
                // Include digits
                const includeBtn = document.createElement('button');
                includeBtn.className = 'digit-button';
                includeBtn.textContent = i;
                includeBtn.id = `include-digit-${i}`;
                includeBtn.onclick = () => toggleIncludeDigit(i);
                includeContainer.appendChild(includeBtn);

                // Exclude digits
                const excludeBtn = document.createElement('button');
                excludeBtn.className = 'digit-button';
                excludeBtn.textContent = i;
                excludeBtn.id = `exclude-digit-${i}`;
                excludeBtn.onclick = () => toggleExcludeDigit(i);
                excludeContainer.appendChild(excludeBtn);
            }
        }

        function initializeSumExclusions() {
            const container = document.getElementById('sumExclusions');
            for (let sum = 3; sum <= 45; sum++) {
                const btn = document.createElement('button');
                btn.className = 'sum-button';
                btn.textContent = sum;
                btn.id = `sum-exclude-${sum}`;
                btn.onclick = () => toggleSumExclusion(sum);
                container.appendChild(btn);
            }
        }

        // Rebuild the Exclude Specific Sums list to only show currently selected target sums
        function updateSumExclusionsForTargetSums(targetSums) {
            const container = document.getElementById('sumExclusions');
            container.innerHTML = '';

            // Keep only exclusions that are within the new target sums
            const targetSet = new Set(targetSums);
            excludeSums = new Set([...excludeSums].filter(s => targetSet.has(s)));

            // Create buttons only for sums in the selected range(s)
            targetSums.sort((a, b) => a - b).forEach(sum => {
                const btn = document.createElement('button');
                btn.className = 'sum-button';
                if (excludeSums.has(sum)) btn.classList.add('excluded');
                btn.textContent = sum;
                btn.id = `sum-exclude-${sum}`;
                btn.onclick = () => toggleSumExclusion(sum);
                container.appendChild(btn);
            });
        }

        function addGroup() {
            const groupId = Date.now();
            groups.push({ id: groupId, digits: new Set() });
            renderGroups();
        }

        function removeGroup(groupId) {
            groups = groups.filter(g => g.id !== groupId);
            renderGroups();
            if (allCombinations.length > 0) {
                displayResults(); // Update results after group change
            }
        }

        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';

            groups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';
                groupDiv.innerHTML = `
                    <div class="group-header">
                        <h4>Group ${index + 1}</h4>
                        <button class="button button-danger button-small" onclick="removeGroup(${group.id})">Remove</button>
                    </div>
                    <div class="digits-container">
                        ${[1,2,3,4,5,6,7,8,9].map(digit => `
                            <button class="digit-button ${group.digits.has(digit) ? 'selected' : ''}" 
                                    onclick="toggleGroupDigit(${group.id}, ${digit})">${digit}</button>
                        `).join('')}
                    </div>
                    <div class="checkbox-container" style="margin-top: 8px;">
                        <input type="checkbox" id="requireFrom${group.id}" ${group.minRequired !== undefined ? 'checked' : ''}>
                        <label for="requireFrom${group.id}">Require at least</label>
                        <input type="number" id="minRequired${group.id}" min="1" max="9" value="${group.minRequired || 1}" 
                               ${group.minRequired !== undefined ? '' : 'disabled'}
                               onchange="updateGroupRequirement(${group.id}, this.value)" style="width: 50px;">
                        <label>digits from this group</label>
                    </div>
                `;
                container.appendChild(groupDiv);
                
                // Add event listener for the checkbox
                const checkbox = container.querySelector(`#requireFrom${group.id}`);
                checkbox.addEventListener('change', function() {
                    const input = container.querySelector(`#minRequired${group.id}`);
                    if (this.checked) {
                        input.disabled = false;
                        group.minRequired = parseInt(input.value);
                    } else {
                        input.disabled = true;
                        delete group.minRequired;
                    }
                    if (allCombinations.length > 0) {
                        displayResults(); // Update results when group requirements change
                    }
                });
            });
        }

        function toggleGroupDigit(groupId, digit) {
            const group = groups.find(g => g.id === groupId);
            if (group.digits.has(digit)) {
                group.digits.delete(digit);
            } else {
                group.digits.add(digit);
            }
            renderGroups();
            if (allCombinations.length > 0) {
                displayResults(); // Update results when group digits change
            }
        }

        function updateGroupRequirement(groupId, value) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.minRequired = parseInt(value);
                if (allCombinations.length > 0) {
                    displayResults(); // Update results when requirement value changes
                }
            }
        }

        function toggleIncludeDigit(digit) {
            if (includeDigits.has(digit)) {
                includeDigits.delete(digit);
            } else {
                includeDigits.add(digit);
                excludeDigits.delete(digit); // Remove from exclude if adding to include
            }
            
            // Clear any manual combination exclusions that involved this digit
            // This allows previously grayed combinations to reappear
            const combinationsToRestore = [];
            for (let comboKey of excludedCombinations) {
                const combo = JSON.parse(comboKey);
                if (combo.includes(digit)) {
                    combinationsToRestore.push(comboKey);
                }
            }
            combinationsToRestore.forEach(key => excludedCombinations.delete(key));
            
            updateDigitButtons();
            displayResults(); // Update results immediately
        }

        function toggleExcludeDigit(digit) {
            if (excludeDigits.has(digit)) {
                excludeDigits.delete(digit);
            } else {
                excludeDigits.add(digit);
                includeDigits.delete(digit); // Remove from include if adding to exclude
            }
            
            // Clear any manual combination exclusions that involved this digit
            // This allows previously grayed combinations to reappear
            const combinationsToRestore = [];
            for (let comboKey of excludedCombinations) {
                const combo = JSON.parse(comboKey);
                if (combo.includes(digit)) {
                    combinationsToRestore.push(comboKey);
                }
            }
            combinationsToRestore.forEach(key => excludedCombinations.delete(key));
            
            updateDigitButtons();
            displayResults(); // Update results immediately
        }

        function toggleSumExclusion(sum) {
            if (excludeSums.has(sum)) {
                excludeSums.delete(sum);
            } else {
                excludeSums.add(sum);
            }
            updateSumButtons();
            displayResults(); // Update results immediately
        }

        function updateDigitButtons() {
            // Update include buttons
            const includeContainer = document.getElementById('includeDigits');
            includeContainer.querySelectorAll('.digit-button').forEach((btn, index) => {
                const digit = index + 1;
                btn.classList.toggle('selected', includeDigits.has(digit));
            });

            // Update exclude buttons
            const excludeContainer = document.getElementById('excludeDigits');
            excludeContainer.querySelectorAll('.digit-button').forEach((btn, index) => {
                const digit = index + 1;
                btn.classList.toggle('selected', excludeDigits.has(digit));
            });
        }

        function updateSumButtons() {
            const container = document.getElementById('sumExclusions');
            container.querySelectorAll('.sum-button').forEach(btn => {
                const sum = parseInt(btn.textContent);
                btn.classList.toggle('excluded', excludeSums.has(sum));
            });
        }

        function excludeDigitFromResults(digit) {
            excludeDigits.add(digit);
            includeDigits.delete(digit);
            updateDigitButtons();
            displayResults(); // This will trigger auto-update of digit constraints
        }

        function removeSum(sum) {
            // Add to exclusions instead of separate removedSums set
            excludeSums.add(sum);
            updateSumButtons();
            displayResults();
        }

        function generateCombinations() {
            // Reset results-based data (but keep user settings like cage size, sum, groups)
            excludedCombinations.clear();
            includeDigits.clear();
            excludeDigits.clear();
            excludeSums.clear();
            updateDigitButtons();
            updateSumButtons();

            // Get cage size parameters
            const cageSizeSingleVisible = !document.getElementById('cageSizeSingle').classList.contains('hidden');
            let cageSizes = [];
            
            if (cageSizeSingleVisible) {
                cageSizes = [parseInt(document.getElementById('cageSizeValue').value)];
            } else {
                const min = parseInt(document.getElementById('cageSizeMin').value);
                const max = parseInt(document.getElementById('cageSizeMax').value);
                for (let i = min; i <= max; i++) {
                    cageSizes.push(i);
                }
            }

            // Get sum parameters
            const sumSingleVisible = !document.getElementById('sumSingle').classList.contains('hidden');
            let targetSums = [];
            
            if (sumSingleVisible) {
                targetSums = [parseInt(document.getElementById('sumValue').value)];
            } else {
                const min = parseInt(document.getElementById('sumMin').value);
                const max = parseInt(document.getElementById('sumMax').value);
                for (let i = min; i <= max; i++) {
                    targetSums.push(i);
                }
            }

            // Rebuild the sums exclusion list to only show selected target sums
            updateSumExclusionsForTargetSums(targetSums);
            updateSumButtons();

            const allowDuplicates = document.getElementById('allowDuplicates').checked;
            const maxRepetitions = parseInt(document.getElementById('maxRepetitions').value) || 2;

            // Generate combinations
            allCombinations = [];
            
            cageSizes.forEach(size => {
                targetSums.forEach(targetSum => {
                    const combinations = findCombinations(size, targetSum, allowDuplicates, maxRepetitions);
                    combinations.forEach(combo => {
                        allCombinations.push({
                            digits: combo,
                            sum: targetSum,
                            size: size
                        });
                    });
                });
            });

            // Auto-populate include/exclude digits based on results
            autoUpdateDigitConstraints();

            displayResults();
            showAdvancedFilteringSection();
        }

        function findCombinations(size, targetSum, allowDuplicates, maxRepetitions = 2) {
            let availableDigits = [];
            
            if (groups.length === 0) {
                // If no groups defined, use all digits 1-9
                availableDigits = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            } else {
                // Collect digits from all groups
                const digitSet = new Set();
                groups.forEach(group => {
                    group.digits.forEach(digit => digitSet.add(digit));
                });
                availableDigits = Array.from(digitSet);
            }

            // Apply exclusions
            availableDigits = availableDigits.filter(digit => !excludeDigits.has(digit));

            const combinations = new Set(); // Use Set to avoid duplicates
            
            function backtrackWithDuplicates(current, remaining) {
                if (current.length === size) {
                    if (remaining === 0) {
                        // Check if all include digits are present
                        const currentSet = new Set(current);
                        let hasAllIncludes = true;
                        for (let digit of includeDigits) {
                            if (!currentSet.has(digit)) {
                                hasAllIncludes = false;
                                break;
                            }
                        }
                        
                        // Check max repetitions constraint
                        const digitCounts = {};
                        for (let digit of current) {
                            digitCounts[digit] = (digitCounts[digit] || 0) + 1;
                            if (digitCounts[digit] > maxRepetitions) {
                                return; // Skip this combination
                            }
                        }
                        
                        // Check group requirements
                        if (!checkGroupRequirements(current)) {
                            return;
                        }
                        
                        if (hasAllIncludes) {
                            const sortedCombo = [...current].sort((a, b) => a - b);
                            combinations.add(JSON.stringify(sortedCombo));
                        }
                    }
                    return;
                }
                
                for (let digit of availableDigits) {
                    if (remaining >= digit) {
                        current.push(digit);
                        backtrackWithDuplicates(current, remaining - digit);
                        current.pop();
                    }
                }
            }

            function backtrackWithoutDuplicates(current, remaining, start) {
                if (current.length === size) {
                    if (remaining === 0) {
                        // Check if all include digits are present
                        const currentSet = new Set(current);
                        let hasAllIncludes = true;
                        for (let digit of includeDigits) {
                            if (!currentSet.has(digit)) {
                                hasAllIncludes = false;
                                break;
                            }
                        }
                        
                        // Check group requirements
                        if (!checkGroupRequirements(current)) {
                            return;
                        }
                        
                        if (hasAllIncludes) {
                            const sortedCombo = [...current].sort((a, b) => a - b);
                            combinations.add(JSON.stringify(sortedCombo));
                        }
                    }
                    return;
                }
                
                for (let i = start; i < availableDigits.length; i++) {
                    const digit = availableDigits[i];
                    if (remaining >= digit) {
                        current.push(digit);
                        backtrackWithoutDuplicates(current, remaining - digit, i + 1);
                        current.pop();
                    }
                }
            }
            
            if (allowDuplicates) {
                backtrackWithDuplicates([], targetSum);
            } else {
                backtrackWithoutDuplicates([], targetSum, 0);
            }
            
            // Convert Set back to array of arrays
            return Array.from(combinations).map(combo => JSON.parse(combo));
        }

        function checkGroupRequirements(combination) {
            for (let group of groups) {
                if (group.minRequired !== undefined) {
                    const groupDigitsInCombo = combination.filter(digit => group.digits.has(digit)).length;
                    if (groupDigitsInCombo < group.minRequired) {
                        return false;
                    }
                }
            }
            return true;
        }

        function autoUpdateDigitConstraints() {
            if (allCombinations.length === 0) return;

            // Store previous states for comparison
            const prevIncluded = new Set(includeDigits);
            const prevExcluded = new Set(excludeDigits);

            // Count how many combinations each digit appears in
            const digitCounts = {};
            for (let i = 1; i <= 9; i++) {
                digitCounts[i] = 0;
            }

            allCombinations.forEach(combo => {
                const uniqueDigits = [...new Set(combo.digits)];
                uniqueDigits.forEach(digit => {
                    digitCounts[digit]++;
                });
            });

            // Auto-include digits that appear in ALL combinations
            for (let digit = 1; digit <= 9; digit++) {
                if (digitCounts[digit] === allCombinations.length && digitCounts[digit] > 0) {
                    includeDigits.add(digit);
                } else {
                    includeDigits.delete(digit);
                }
            }

            // Auto-exclude digits that appear in NO combinations
            for (let digit = 1; digit <= 9; digit++) {
                if (digitCounts[digit] === 0) {
                    excludeDigits.add(digit);
                } else {
                    excludeDigits.delete(digit);
                }
            }

            // Visual feedback for changed digits
            for (let digit = 1; digit <= 9; digit++) {
                const wasIncluded = prevIncluded.has(digit);
                const nowIncluded = includeDigits.has(digit);
                const wasExcluded = prevExcluded.has(digit);
                const nowExcluded = excludeDigits.has(digit);

                if (wasIncluded !== nowIncluded) {
                    const btn = document.getElementById(`include-digit-${digit}`);
                    if (btn) {
                        btn.classList.add('auto-updated');
                        setTimeout(() => btn.classList.remove('auto-updated'), 2500);
                    }
                }

                if (wasExcluded !== nowExcluded) {
                    const btn = document.getElementById(`exclude-digit-${digit}`);
                    if (btn) {
                        btn.classList.add('auto-updated');
                        setTimeout(() => btn.classList.remove('auto-updated'), 2500);
                    }
                }
            }

            updateDigitButtons();
        }

        function updateStatistics() {
            if (allCombinations.length === 0) return;

            // Filter combinations based on current constraints
            const filteredCombinations = allCombinations.filter(combo => {
                if (excludeSums.has(combo.sum)) return false;
                if (includeDigits.size > 0) {
                    const comboDigitSet = new Set(combo.digits);
                    for (let requiredDigit of includeDigits) {
                        if (!comboDigitSet.has(requiredDigit)) {
                            return false;
                        }
                    }
                }
                if (combo.digits.some(digit => excludeDigits.has(digit))) {
                    return false;
                }
                if (!checkGroupRequirements(combo.digits)) {
                    return false;
                }
                const comboKey = JSON.stringify(combo.digits);
                if (excludedCombinations.has(comboKey)) return false;
                return true;
            });

            // Calculate digit frequencies
            const digitFreq = {};
            for (let i = 1; i <= 9; i++) {
                digitFreq[i] = 0;
            }

            filteredCombinations.forEach(combo => {
                combo.digits.forEach(digit => {
                    digitFreq[digit]++;
                });
            });

            // Find most and least common digits
            const freqValues = Object.values(digitFreq).filter(f => f > 0);
            const maxFreq = Math.max(...freqValues);
            const minFreq = Math.min(...freqValues);

            // Update digit frequency display
            const digitFreqContainer = document.getElementById('digitFrequency');
            digitFreqContainer.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const freqBar = document.createElement('div');
                freqBar.className = 'freq-bar';
                
                if (digitFreq[i] === maxFreq && digitFreq[i] > 0) {
                    freqBar.classList.add('most-common');
                } else if (digitFreq[i] === minFreq && freqValues.length > 1) {
                    freqBar.classList.add('least-common');
                }
                
                freqBar.innerHTML = `
                    <span class="freq-number">${i}</span>
                    <span class="freq-count">${digitFreq[i]}</span>
                `;
                digitFreqContainer.appendChild(freqBar);
            }

            // Calculate sum frequencies
            const sumFreq = {};
            filteredCombinations.forEach(combo => {
                sumFreq[combo.sum] = (sumFreq[combo.sum] || 0) + 1;
            });

            // Sort sums by frequency and show top 8
            const topSums = Object.entries(sumFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            // Update sum frequency display
            const sumFreqContainer = document.getElementById('sumFrequency');
            sumFreqContainer.innerHTML = '';
            topSums.forEach(([sum, count], index) => {
                const sumItem = document.createElement('div');
                sumItem.className = 'sum-freq-item';
                if (index === 0) {
                    sumItem.classList.add('top-sum');
                }
                sumItem.innerHTML = `<span>Sum ${sum}</span><span>${count}</span>`;
                sumFreqContainer.appendChild(sumItem);
            });
        }

        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            if (allCombinations.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No combinations found</h3><p>Try adjusting your parameters or removing some exclusions.</p></div>';
                updateOverview(0, {}, {});
                showResults();
                return;
            }

            // Filter combinations based on current constraints
            const filteredCombinations = allCombinations.filter(combo => {
                // Skip if sum is excluded
                if (excludeSums.has(combo.sum)) return false;
                
                // Check if combination contains ALL required include digits
                if (includeDigits.size > 0) {
                    const comboDigitSet = new Set(combo.digits);
                    for (let requiredDigit of includeDigits) {
                        if (!comboDigitSet.has(requiredDigit)) {
                            return false;
                        }
                    }
                }
                
                // Check if combination contains any excluded digits
                if (combo.digits.some(digit => excludeDigits.has(digit))) {
                    return false;
                }
                
                // Check group requirements
                if (!checkGroupRequirements(combo.digits)) {
                    return false;
                }

                return true;
            });

            // Auto-update digit constraints based on filtered results
            autoUpdateDigitConstraintsFromFiltered(filteredCombinations);

            // Update statistics
            updateStatistics();

            // Group combinations by cage size and sum
            const groupedResults = {};
            let totalCombinations = 0;
            const sizeCounts = {};
            const sumCounts = {};

            filteredCombinations.forEach(combo => {
                const comboKey = JSON.stringify(combo.digits);
                
                // Check if manually excluded by user clicking
                let isExcluded = excludedCombinations.has(comboKey);
                
                if (!groupedResults[combo.size]) {
                    groupedResults[combo.size] = {};
                }
                if (!groupedResults[combo.size][combo.sum]) {
                    groupedResults[combo.size][combo.sum] = [];
                }
                groupedResults[combo.size][combo.sum].push({...combo, excluded: isExcluded});
                
                if (!isExcluded) {
                    totalCombinations++;
                    sizeCounts[combo.size] = (sizeCounts[combo.size] || 0) + 1;
                    sumCounts[combo.sum] = (sumCounts[combo.sum] || 0) + 1;
                }
            });

            // Display results
            Object.keys(groupedResults).sort((a, b) => parseInt(a) - parseInt(b)).forEach(size => {
                const sizeSection = document.createElement('div');
                sizeSection.className = 'cage-size-section';
                sizeSection.id = `size-${size}`;
                
                const validCombos = Object.values(groupedResults[size]).flat().filter(c => !c.excluded).length;
                sizeSection.innerHTML = `<h3 class="cage-size-header">Cage Size: ${size} cells (${validCombos} valid)</h3>`;
                
                Object.keys(groupedResults[size]).sort((a, b) => parseInt(a) - parseInt(b)).forEach(sum => {
                    const validSumCombos = groupedResults[size][sum].filter(c => !c.excluded).length;
                    
                    // Skip sums that have no valid combinations (automatically remove empty sums)
                    if (validSumCombos === 0) return;
                    
                    const sumSection = document.createElement('div');
                    sumSection.className = 'sum-section';
                    sumSection.id = `sum-${sum}`;
                    
                    const totalSumCombos = groupedResults[size][sum].length;
                    sumSection.innerHTML = `
                        <h4 class="sum-header">
                            <span>Sum: ${sum} (${validSumCombos}/${totalSumCombos} combinations)</span>
                            <button class="sum-remove-btn" onclick="removeSum(${sum})" title="Remove this sum">√ó</button>
                        </h4>
                    `;
                    
                    const combinationsDiv = document.createElement('div');
                    combinationsDiv.className = 'combinations';
                    
                    groupedResults[size][sum].forEach(combo => {
                        const comboDiv = document.createElement('div');
                        comboDiv.className = 'combination';
                        const comboKey = JSON.stringify(combo.digits);
                        
                        if (combo.excluded) {
                            comboDiv.classList.add('grayed-out');
                        }
                        
                        comboDiv.onclick = (e) => {
                            e.stopPropagation();
                            toggleCombination(combo.digits);
                        };
                        
                        const digitsHtml = combo.digits.map(digit => 
                            `<span class="clickable-digit" onclick="event.stopPropagation(); excludeDigitFromResults(${digit})">${digit}</span>`
                        ).join(', ');
                        
                        comboDiv.innerHTML = `
                            <div class="combination-digits">[${digitsHtml}]</div>
                            ${combo.excluded ? '<div class="restore-hint">Click to restore</div>' : ''}
                        `;
                        combinationsDiv.appendChild(comboDiv);
                    });
                    
                    sumSection.appendChild(combinationsDiv);
                    sizeSection.appendChild(sumSection);
                });
                
                container.appendChild(sizeSection);
            });

            updateOverview(totalCombinations, sizeCounts, sumCounts);
            showResults();
        }

        function autoUpdateDigitConstraintsFromFiltered(filteredCombinations) {
            if (allCombinations.length === 0) return;

            // Store previous states for comparison
            const prevIncluded = new Set(includeDigits);
            const prevExcluded = new Set(excludeDigits);

            // Count how many combinations each digit appears in AFTER considering manual exclusions
            const digitCounts = {};
            for (let i = 1; i <= 9; i++) {
                digitCounts[i] = 0;
            }

            // Count from all combinations, but exclude manually excluded combinations
            allCombinations.forEach(combo => {
                const comboKey = JSON.stringify(combo.digits);
                
                // Skip manually excluded combinations
                if (excludedCombinations.has(comboKey)) return;
                
                // Skip combinations excluded by current filters
                if (excludeSums.has(combo.sum)) return;
                if (combo.digits.some(d => excludeDigits.has(d))) return;
                if (includeDigits.size > 0 && !Array.from(includeDigits).every(d => combo.digits.includes(d))) return;
                if (!checkGroupRequirements(combo.digits)) return;
                
                const uniqueDigits = [...new Set(combo.digits)];
                uniqueDigits.forEach(digit => {
                    digitCounts[digit]++;
                });
            });

            // Count total valid combinations
            const totalValidCombinations = allCombinations.filter(combo => {
                const comboKey = JSON.stringify(combo.digits);
                return !excludedCombinations.has(comboKey) && 
                       !excludeSums.has(combo.sum) && 
                       !combo.digits.some(d => excludeDigits.has(d)) &&
                       (includeDigits.size === 0 || Array.from(includeDigits).every(d => combo.digits.includes(d))) &&
                       checkGroupRequirements(combo.digits);
            }).length;

            // Auto-include digits that appear in ALL valid combinations (but don't override manual choices)
            for (let digit = 1; digit <= 9; digit++) {
                if (digitCounts[digit] === totalValidCombinations && totalValidCombinations > 0) {
                    if (!prevExcluded.has(digit)) { // Don't auto-include if user manually excluded
                        includeDigits.add(digit);
                    }
                } else if (digitCounts[digit] < totalValidCombinations) {
                    // Only remove from include if it wasn't manually added
                    if (digitCounts[digit] === 0 || !prevIncluded.has(digit)) {
                        includeDigits.delete(digit);
                    }
                }
            }

            // Auto-exclude digits that appear in NO valid combinations (but don't override manual choices)
            for (let digit = 1; digit <= 9; digit++) {
                if (digitCounts[digit] === 0) {
                    if (!prevIncluded.has(digit)) { // Don't auto-exclude if user manually included
                        excludeDigits.add(digit);
                    }
                } else if (digitCounts[digit] > 0) {
                    // Only remove from exclude if it wasn't manually added
                    if (!prevExcluded.has(digit)) {
                        excludeDigits.delete(digit);
                    }
                }
            }

            // Visual feedback for changed digits
            for (let digit = 1; digit <= 9; digit++) {
                const wasIncluded = prevIncluded.has(digit);
                const nowIncluded = includeDigits.has(digit);
                const wasExcluded = prevExcluded.has(digit);
                const nowExcluded = excludeDigits.has(digit);

                if (wasIncluded !== nowIncluded) {
                    const btn = document.getElementById(`include-digit-${digit}`);
                    if (btn) {
                        btn.classList.add('auto-updated');
                        setTimeout(() => btn.classList.remove('auto-updated'), 2500);
                    }
                }

                if (wasExcluded !== nowExcluded) {
                    const btn = document.getElementById(`exclude-digit-${digit}`);
                    if (btn) {
                        btn.classList.add('auto-updated');
                        setTimeout(() => btn.classList.remove('auto-updated'), 2500);
                    }
                }
            }

            updateDigitButtons();
        }

        function toggleCombination(digits) {
            const key = JSON.stringify(digits);
            if (excludedCombinations.has(key)) {
                excludedCombinations.delete(key);
            } else {
                excludedCombinations.add(key);
            }
            displayResults();
        }

        function updateOverview(total, sizeCounts, sumCounts) {
            document.getElementById('totalCount').textContent = total;
            
            // Size counts - sorted in ascending order
            const sizeContainer = document.getElementById('sizeCountsContainer');
            sizeContainer.innerHTML = '';
            Object.keys(sizeCounts).sort((a, b) => parseInt(a) - parseInt(b)).forEach(size => {
                const badge = document.createElement('span');
                badge.className = 'count-badge';
                badge.textContent = `${size} (${sizeCounts[size]})`;
                badge.onclick = () => scrollToElement(`size-${size}`);
                sizeContainer.appendChild(badge);
            });

            // Sum counts - sorted in ascending order (show top 15 by count, but in ascending sum order)
            const sumContainer = document.getElementById('sumCountsContainer');
            sumContainer.innerHTML = '';
            const topSums = Object.entries(sumCounts)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending first
                .slice(0, 15) // Take top 15
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0])); // Then sort by sum ascending
                
            topSums.forEach(([sum, count]) => {
                const badge = document.createElement('span');
                badge.className = 'count-badge';
                badge.textContent = `${sum} (${count})`;
                badge.onclick = () => scrollToElement(`sum-${sum}`);
                sumContainer.appendChild(badge);
            });
        }

        function scrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function showAdvancedFilteringSection() {
            document.getElementById('advancedFilteringSection').classList.remove('hidden');
        }

        function showResults() {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('statisticsDashboard').classList.remove('hidden');
            document.getElementById('overviewBar').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
        }
    </script>
</body>
</html>